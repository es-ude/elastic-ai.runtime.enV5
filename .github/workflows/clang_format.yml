# Based on https://github.com/marketplace/actions/git-clang-format-action

name: "Format code"

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  checks:
    uses: 
    - ./.github/workflows/unit_test.yml
    - ./.github/workflows/build_all_targets.yml

  format:
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Clang
        run: |
          sudo apt update
          sudo apt install clang-format -y

      - name: Get files to apply Clang
        run: echo SRC=$(git ls-tree --full-tree -r HEAD | cut -f 2 | grep -e "\.\(c\|h\)\$" | grep -v ^extern) >> $GITHUB_ENV

      - name: Apply Clang
        run: clang-format --style=file --fallback-style=llvm -i $SRC

      - name: commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "style: apply clang-format"
          commit_user_name: github-actions
          commit_author: github-actions <action@github.com>
          commit_user_email: action@github.com
